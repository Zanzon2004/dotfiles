#!/usr/bin/env bash

notify() {
    notify-send \
        --expire-time=4000 \
        --hint=string:x-canonical-private-synchronous:battery \
        "Battery" "$1"
}

case "$BLOCK_BUTTON" in
    1) notify "$(acpi -b | awk -F ': |, ' '{printf "%s\n%s\n", $2, $4}')" ;;
    3) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

perc=$(cat /sys/class/power_supply/BAT1/capacity)
status=$(cat /sys/class/power_supply/BAT1/status)

if [ "$status" != "Discharging" ]; then
    icon='❘ 󰂄'
elif [ "$perc" -ge 90 ]; then
    icon='❘ 󰁹'
elif [ "$perc" -ge 70 ]; then
    icon='❘ 󰁿'
elif [ "$perc" -ge 40 ]; then
    icon='❘ 󰁼'
elif [ "$perc" -ge 15 ]; then
    icon='❘ 󰁻'
else
    icon='❘ 󰂎'
fi

# Notify when battery < 15%
if [ "$status" = "Discharging" ] && [ "$perc" -le 15 ]; then
    last_file=/tmp/last_batt_warn
    last=100
    [ -f "$last_file" ] && last=$(cat "$last_file")
    if [ $((last - perc)) -ge 5 ] || [ "$perc" -le 5 ]; then
        notify-send -u critical -t 5000 "Battery low!" "Only $perc% remaining"
        echo "$perc" > "$last_file"
    fi
fi

echo "$icon $perc%"
